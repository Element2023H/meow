#include <windows.h>
#include <stdio.h>
#include <stdlib.h>

#define TEA_BLOCK_SIZE 8
#define ROUNDS 32

void tea_encrypt(unsigned char* data, unsigned char* key) {
  unsigned int i;
  unsigned int delta = 0x9e3779b9;
  unsigned int sum = 0;
  unsigned int v0 = *(unsigned int*)data;
  unsigned int v1 = *(unsigned int*)(data + 4);

  for (i = 0; i < ROUNDS; i++) {
    v0 += (((v1 << 4) ^ (v1 >> 5)) + v1) ^ (sum + ((unsigned int*)key)[sum & 3]);
    sum += delta;
    v1 += (((v0 << 4) ^ (v0 >> 5)) + v0) ^ (sum + ((unsigned int*)key)[(sum >> 11) & 3]);
  }

  *(unsigned int*)data = v0;
  *(unsigned int*)(data + 4) = v1;
}

void tea_decrypt(unsigned char* data, unsigned char* key) {
  unsigned int i;
  unsigned int delta = 0x9e3779b9;
  unsigned int sum = delta * ROUNDS;
  unsigned int v0 = *(unsigned int*)data;
  unsigned int v1 = *(unsigned int*)(data + 4);

  for (i = 0; i < ROUNDS; i++) {
    v1 -= (((v0 << 4) ^ (v0 >> 5)) + v0) ^ (sum + ((unsigned int*)key)[(sum >> 11) & 3]);
    sum -= delta;
    v0 -= (((v1 << 4) ^ (v1 >> 5)) + v1) ^ (sum + ((unsigned int*)key)[sum & 3]);
  }

  *(unsigned int*)data = v0;
  *(unsigned int*)(data + 4) = v1;
}

void addPadding(FILE* file) {
  fpos_t position;
  fgetpos(file, &position);
  int remainder = position % TEA_BLOCK_SIZE;
  if (remainder > 0) {
    int padding = TEA_BLOCK_SIZE - remainder;
    for (int i = 0; i < padding; ++i) {
      fputc(padding, file);
    }
  }
}

void encryptFile(const char* inputFile, const char* outputFile, const char* teaKey) {
  FILE* ifh = fopen(inputFile, "rb");
  FILE* ofh = fopen(outputFile, "wb");

  if (ifh == NULL || ofh == NULL) {
    printf("Error opening file.\n");
    return;
  }

  unsigned char key[TEA_BLOCK_SIZE];
  memcpy(key, teaKey, TEA_BLOCK_SIZE);

  int ch;
  while ((ch = fgetc(ifh)) != EOF) {
    fputc(ch, ofh);
  }

  addPadding(ofh);

  fseek(ofh, 0, SEEK_SET);
  unsigned char block[TEA_BLOCK_SIZE];
  size_t bytesRead;
  while ((bytesRead = fread(block, 1, TEA_BLOCK_SIZE, ofh)) > 0) {
    tea_encrypt(block, key);
    fseek(ofh, -bytesRead, SEEK_CUR);
    fwrite(block, 1, bytesRead, ofh);
    fseek(ofh, 0, SEEK_CUR);
  }

  fclose(ifh);
  fclose(ofh);

  printf("TEA encryption successful\n");
}

void decryptFile(const char* inputFile, const char* outputFile, const char* teaKey) {
  FILE* ifh = fopen(inputFile, "rb");
  FILE* ofh = fopen(outputFile, "wb");

  if (ifh == NULL || ofh == NULL) {
    printf("Error opening file.\n");
    return;
  }

  unsigned char key[TEA_BLOCK_SIZE];
  memcpy(key, teaKey, TEA_BLOCK_SIZE);

  unsigned char block[TEA_BLOCK_SIZE];
  size_t bytesRead;
  while ((bytesRead = fread(block, 1, TEA_BLOCK_SIZE, ifh)) > 0) {
    tea_decrypt(block, key);
    fwrite(block, 1, bytesRead, ofh);
  }

  fclose(ifh);
  fclose(ofh);

  printf("TEA decryption successful\n");
}

int main() {
  const char* inputFile = "C:\\Users\\user\\Desktop\\books\\test.txt";
  const char* outputFile = "C:\\Users\\user\\Desktop\\books\\test.txt.tea";
  const char* decryptedFile = "C:\\Users\\user\\Desktop\\books\\test.txt.tea.decrypted";
  const char* teaKey = "\x6d\x65\x6f\x77\x6d\x65\x6f\x77\x6d\x65\x6f\x77\x6d\x65\x6f\x77";
  encryptFile(inputFile, outputFile, teaKey);
  decryptFile(outputFile, decryptedFile, teaKey);
  return 0;
}

