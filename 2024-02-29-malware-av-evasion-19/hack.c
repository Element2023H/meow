/*
 * hack.c
 * anti-debug via page guard
 * author: @cocomelonc
 * https://cocomelonc.github.io/malware/2024/02/29/malware-evsaion-19.html
*/
#include <stdio.h>
#include <windows.h>

BOOL IsDebugged() {
  UCHAR *memory = NULL;
  SYSTEM_INFO systemInfo = { 0 };
  DWORD oldProtect = 0;
  PVOID allocation = NULL;

  // Retrieves information about the current system.
  GetSystemInfo(&systemInfo);

  // Allocate memory 
  allocation = VirtualAlloc(NULL, systemInfo.dwPageSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);
  if (allocation == NULL)
    return FALSE;

  // Write a ret instruction to the buffer (opcode 0xc3)
  memset(allocation, 0xC3, 1);

  // Make the page a guard page     
  if (VirtualProtect(allocation, systemInfo.dwPageSize, PAGE_EXECUTE_READWRITE | PAGE_GUARD, &oldProtect) == 0)
    return FALSE;
  
  __try {
    ((void(*)())allocation)(); // Exception or execution, which shall it be :D?
  }
  __except (EXCEPTION_EXECUTE_HANDLER) {
    memory = (UCHAR*)1; // Debugger detected
  }

  VirtualFree(allocation, 0, MEM_RELEASE);
  return FALSE; // No debugger detected
}

int main() {
  if (IsDebugged()) {
    MessageBoxA(NULL, "Bow-wow!", "=^..^=", MB_OK);
    return 1;
  }
  MessageBoxA(NULL, "Meow-meow!", "=^..^=", MB_OK);
  return 0;
}
